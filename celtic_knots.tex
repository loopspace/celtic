\documentclass{article}
\usepackage{tikz}
\usepackage{expl3}
\usepackage{xparse}

\ExplSyntaxOn

\cs_new_nopar:Npn \celtic_shift:n #1
{
  \use:c{tikz@scan@one@point}\pgftransformshift #1\relax
}


\int_new:N \l__celtic_max_steps_int
\int_new:N \l__celtic_int
\int_new:N \l__celtic_flip_int
\int_new:N \l__celtic_width_int
\int_new:N \l__celtic_height_int
\int_new:N \l__celtic_x
\int_new:N \l__celtic_y
\int_new:N \l__celtic_dx
\int_new:N \l__celtic_dy
\int_new:N \l__celtic_ox
\int_new:N \l__celtic_oy
\int_new:N \l__celtic_lout
\int_new:N \l__celtic_cross_int
\fp_new:N \l__celtic_clip_fp
\fp_new:N \l__celtic_inner_clip_fp
\fp_new:N \l__celtic_inner_fp
\fp_new:N \l__celtic_outer_fp
\seq_new:N \l__celtic_path_seq
\seq_new:N \l__celtic_crossing_seq
\seq_new:N \l__celtic_tmpa_seq
\clist_new:N \l__celtic_tmpa_clist
\tl_new:N \l__celtic_tmpa_tl
\tl_new:N \l__celtic_path_tl
\tl_new:N \g__celtic_colon_tl
\bool_new:N \l__celtic_bounce_bool
\bool_new:N \l__celtic_pbounce_bool

\group_begin:
\char_set_lccode:nn {`;}{`:}
\tl_to_lowercase:n {
\group_end:
  \tl_set:Nn \g__celtic_colon_tl {;}
}

\cs_generate_variant:Nn \tl_if_single_p:N {c}
\cs_generate_variant:Nn \tl_if_single:NTF {cTF}
\cs_generate_variant:Nn \tl_if_eq:nnTF {xnTF}
\cs_generate_variant:Nn \tl_head:N {c}
\cs_generate_variant:Nn \tl_tail:N {c}
\cs_generate_variant:Nn \tl_if_eq:nnTF {vnTF}

\int_set:Nn \l__celtic_max_steps_int {20}
\fp_set:Nn \l__celtic_inner_fp {1}
\fp_set:Nn \l__celtic_outer_fp {2}

\cs_new_nopar:Npn \celtic_set_crossing:nnn #1#2#3
{
  \tl_set:cn {crossing \int_eval:n {#1} - \int_eval:n{#2}}{#3}
}

\cs_generate_variant:Nn \tl_if_in:nnTF {nVTF}

\cs_new_nopar:Npn \celtic_set_symmetric_crossing:nnn #1#2#3
{
  \tl_if_in:nVTF {#1} \g__celtic_colon_tl
  {
    \celtic_set_symmetric_crossing_auxa:w #1;{#2}{#3}
  }
  {
    \celtic_set_symmetric_crossing_auxb:nnn {#1}{#2}{#3}
  }
}

\tl_set:Nx \l_tmpa_tl
{
  \exp_not:N \cs_new_nopar:Npn \exp_not:N \celtic_set_symmetric_crossing_auxa:w ##1\tl_use:N \g__celtic_colon_tl ##2;##3##4
  {
    \exp_not:N \int_step_inline:nnnn {##1} {2} {##2}
    {
      \exp_not:N \celtic_set_symmetric_crossing_auxb:nnn {####1}{##3}{##4}
    }
  }
  \exp_not:N \cs_new_nopar:Npn \exp_not:N \celtic_set_symmetric_crossing_auxc:w ##1##2\tl_use:N \g__celtic_colon_tl ##3;##4
  {
    \exp_not:N\int_step_inline:nnnn {##2} {2} {##3}
    {
      \exp_not:N\celtic_set_symmetric_crossing_aux:nnn {##1}{####1}{##4}
    }
  }
}
\tl_use:N \l_tmpa_tl

\cs_new_nopar:Npn \celtic_set_symmetric_crossing_auxb:nnn #1#2#3
{
  \tl_if_in:nVTF {#2} \g__celtic_colon_tl
  {
    \celtic_set_symmetric_crossing_auxc:w {#1}#2;{#3}
  }
  {
    \celtic_set_symmetric_crossing_aux:nnn {#1}{#2}{#3}
  }
}


\cs_new_nopar:Npn \celtic_set_symmetric_crossing_aux:nnn #1#2#3
{
  \tl_set:cn {crossing \int_eval:n {#1} - \int_eval:n{#2}}{#3}
  \tl_set:cn {crossing \int_eval:n {\l__celtic_width_int - #1} - \int_eval:n{#2}}{#3}
  \tl_set:cn {crossing \int_eval:n {#1} - \int_eval:n{\l__celtic_height_int - #2}}{#3}
  \tl_set:cn {crossing \int_eval:n {\l__celtic_width_int - #1} - \int_eval:n{\l__celtic_height_int - #2}}{#3}
}

\cs_new_nopar:Npn \celtic_set_symmetric_crossing:w #1,#2,#3
{
  \celtic_set_symmetric_crossing:nnn {#1}{#2}{#3}
}

\cs_new_nopar:Npn \celtic_set_crossing:w #1,#2,#3
{
  \celtic_set_crossing:nnn {#1}{#2}{#3}
}

\cs_new_nopar:Npn \celtic_next_crossing:
{
  \int_zero:N \l__celtic_cross_int
  \tl_clear:N \l__celtic_crossing_tl
  \tl_clear:N \l__celtic_path_tl
  \tl_put_right:Nx \l__celtic_path_tl {(\int_use:N \l__celtic_x, \int_use:N \l__celtic_y)}
  \int_set:Nn \l__celtic_lout {(90 - \l__celtic_dx * 45) * \l__celtic_dy}

  \bool_do_until:nn {\int_compare_p:n {\l__celtic_cross_int > 1}}
  {
    \bool_set_eq:NN \l__celtic_pbounce_bool \l__celtic_bounce_bool
    \bool_set_false:N \l__celtic_bounce_bool
    
    \int_add:Nn \l__celtic_x {\l__celtic_dx}
    \int_add:Nn \l__celtic_y {\l__celtic_dy}

    \tl_if_exist:cT {crossing \int_use:N \l__celtic_x - \int_use:N       \l__celtic_y}
    {
      \tl_if_eq:vnTF {crossing \int_use:N \l__celtic_x - \int_use:N \l__celtic_y} {|}
      {
        \bool_if:NTF \l__celtic_pbounce_bool
        {
          \tl_put_right:Nn \l__celtic_path_tl { -| }
        }
        {
          \tl_put_right:Nx \l__celtic_path_tl { to[out=\int_eval:n
{(90 - 45*\l__celtic_dx)*\l__celtic_dy}, in=\int_eval:n
{-90*\l__celtic_dy}] }
        }
        \int_set:Nn \l__celtic_lout {90*\l__celtic_dy}
        \int_set:Nn \l__celtic_dx {-\l__celtic_dx}
        \tl_put_right:Nx  \l__celtic_path_tl {(\fp_eval:n           {\int_use:N \l__celtic_x + .5 * \int_use:N \l__celtic_dx}, \int_use:N \l__celtic_y)}
        \bool_set_true:N \l__celtic_bounce_bool
      }
      {
        \bool_if:NTF \l__celtic_pbounce_bool
        {
          \tl_put_right:Nn \l__celtic_path_tl { |- }
        }
        {
          \tl_put_right:Nx \l__celtic_path_tl { to[out=\int_eval:n {(90 - 45*\l__celtic_dx)*\l__celtic_dy}, in=\int_eval:n {90 + 90*\l__celtic_dx}] }
        }
        \int_set:Nn \l__celtic_lout {90-90*\l__celtic_dx}
        \int_set:Nn \l__celtic_dy {-\l__celtic_dy}
        \tl_put_right:Nx \l__celtic_path_tl {(\int_use:N \l__celtic_x, \fp_eval:n {\int_use:N \l__celtic_y + .5 * \int_use:N \l__celtic_dy})}
        \bool_set_true:N \l__celtic_bounce_bool
      }
    }
    \int_compare:nT {\l__celtic_x == 0}
    {
      \bool_if:NTF \l__celtic_pbounce_bool
      {
        \tl_put_right:Nn \l__celtic_path_tl { -| }
      }
      {
        \tl_put_right:Nx \l__celtic_path_tl { to[out=\int_eval:n {(90 - 45*\l__celtic_dx)*\l__celtic_dy}, in=\int_eval:n {-90*\l__celtic_dy}] }
      }
      \int_set:Nn \l__celtic_lout {90*\l__celtic_dy}
      \int_set:Nn \l__celtic_dx {-\l__celtic_dx}
      \tl_put_right:Nx  \l__celtic_path_tl {(\fp_eval:n {\int_use:N \l__celtic_x + .5 * \int_use:N \l__celtic_dx}, \int_use:N \l__celtic_y)}
      \bool_set_true:N \l__celtic_bounce_bool
    }
    \int_compare:nT {\l__celtic_x == \l__celtic_width_int}
    {
      \bool_if:NTF \l__celtic_pbounce_bool
      {
        \tl_put_right:Nn \l__celtic_path_tl { -| }
      }
      {
        \tl_put_right:Nx \l__celtic_path_tl { to[out=\int_eval:n {(90 - 45*\l__celtic_dx)*\l__celtic_dy}, in=\int_eval:n {-90*\l__celtic_dy}] }
      }
      \int_set:Nn \l__celtic_lout {90*\l__celtic_dy}
      \int_set:Nn \l__celtic_dx {-\l__celtic_dx}
      \tl_put_right:Nx \l__celtic_path_tl {(\fp_eval:n {\int_use:N \l__celtic_x + .5 * \int_use:N \l__celtic_dx}, \int_use:N \l__celtic_y)}
      \bool_set_true:N \l__celtic_bounce_bool
    }
    \int_compare:nT {\l__celtic_y == 0}
    {
      \bool_if:NTF \l__celtic_pbounce_bool
      {
        \tl_put_right:Nn \l__celtic_path_tl { |- }
      }
      {
        \tl_put_right:Nx \l__celtic_path_tl { to[out=\int_eval:n {(90 - 45*\l__celtic_dx)*\l__celtic_dy}, in=\int_eval:n {90 + 90*\l__celtic_dx}] }
      }
      \int_set:Nn \l__celtic_lout {90-90*\l__celtic_dx}
      \int_set:Nn \l__celtic_dy {-\l__celtic_dy}
      \tl_put_right:Nx \l__celtic_path_tl {(\int_use:N \l__celtic_x, \fp_eval:n {\int_use:N \l__celtic_y + .5 * \int_use:N \l__celtic_dy})}
      \bool_set_true:N \l__celtic_bounce_bool
    }
    \int_compare:nT {\l__celtic_y == \l__celtic_height_int}
    {
      \bool_if:NTF \l__celtic_pbounce_bool
      {
        \tl_put_right:Nn \l__celtic_path_tl { |- }
      }
      {
        \tl_put_right:Nx \l__celtic_path_tl { to[out=\int_eval:n {(90 - 45*\l__celtic_dx)*\l__celtic_dy}, in=\int_eval:n {90 + 90*\l__celtic_dx}] }
      }
      \int_set:Nn \l__celtic_lout {-90+90*\l__celtic_dx}
      \int_set:Nn \l__celtic_dy {-\l__celtic_dy}
      \tl_put_right:Nx \l__celtic_path_tl {(\int_use:N \l__celtic_x, \fp_eval:n {\int_use:N \l__celtic_y + .5 * \int_use:N \l__celtic_dy})}
      \bool_set_true:N \l__celtic_bounce_bool
    }

    \bool_if:NF \l__celtic_bounce_bool
    {
      \bool_if:NTF \l__celtic_pbounce_bool
      {
        \tl_put_right:Nx \l__celtic_path_tl { to[out=\int_use:N \l__celtic_lout,in=\int_eval:n {(-90 - 45 * \l__celtic_dx)*\l__celtic_dy}] }
      }
      {
        \tl_put_right:Nn \l__celtic_path_tl { -- }
      }
      \tl_put_right:Nx  \l__celtic_path_tl { (\int_use:N         \l__celtic_x, \int_use:N \l__celtic_y)}
      \tl_if_empty:NTF \l__celtic_crossing_tl
      {
        \tl_set:Nx \l__celtic_crossing_tl {(\int_use:N         \l__celtic_x, \int_use:N \l__celtic_y)}
      }
      {
        \tl_clear:c {crossing used \int_use:N \l__celtic_x - \int_use:N \l__celtic_y}
      }
      \int_incr:N \l__celtic_cross_int
      \int_set:Nn \l__celtic_lout {(90 - \l__celtic_dx * 45) * \l__celtic_dy}
    }
  }
}


\keys_define:nn { celtic }
{
  max~ steps .int_set:N = \l__celtic_max_steps_int,
  flip .code:n = {
    \int_set:Nn \l__celtic_flip_int {-1}
  },
  width .int_set:N = \l__celtic_width_int,
  height .int_set:N = \l__celtic_height_int,
  size .code:n = {
    \clist_set:Nn \l__celtic_tmpa_clist {#1}
    \clist_pop:NN \l__celtic_tmpa_clist \l__celtic_tmpa_tl
    \int_set:Nn \l__celtic_width_int {\l__celtic_tmpa_tl}
    \clist_pop:NN \l__celtic_tmpa_clist \l__celtic_tmpa_tl
    \int_set:Nn \l__celtic_height_int {\l__celtic_tmpa_tl}
  },
  crossings .code:n = {
    \seq_set_split:Nnn \l__celtic_tmpa_seq {;} {#1}
    \seq_map_inline:Nn \l__celtic_tmpa_seq {
      \celtic_set_crossing:w ##1
    }
  },
  symmetric~ crossings .code:n = {
    \seq_set_split:Nnn \l__celtic_tmpa_seq {;} {#1}
    \seq_map_inline:Nn \l__celtic_tmpa_seq {
      \celtic_set_symmetric_crossing:w ##1
    }
  },
  style .code:n = {
    \tikzset {#1}
  },
  at .code:n = {
    \celtic_shift:n {#1}
  },
  inner~ clip .fp_set:N = \l__celtic_inner_fp,
  outer~ clip .fp_set:N = \l__celtic_outer_fp,
}

\DeclareDocumentCommand \CelticDrawPath {O{}}
{
  \group_begin:
  \pgfscope
  \seq_clear:N \l__celtic_path_seq
  \seq_clear:N \l__celtic_crossing_seq
  \int_set:Nn \l__celtic_flip_int {1}

  \int_step_inline:nnnn {1} {1} {\l__celtic_height_int-1}
  {
    \int_step_inline:nnnn {1 + \int_mod:nn {##1}{2}} {2} {\l__celtic_width_int-1}
{
  \tl_clear_new:c {crossing used ####1 - ##1}
  \tl_set:cn {crossing used ####1 - ##1} {X}
}
  }

  \keys_set:nn { celtic } {#1}

  \path[celtic~ bar/.try, celtic~ surround/.try] (0,0) rectangle (\int_use:N \l__celtic_width_int, \int_use:N \l__celtic_height_int);

  \int_step_inline:nnnn {1} {1} {\l__celtic_height_int-1}
  {
    \int_step_inline:nnnn {1 + \int_mod:nn {##1}{2}} {2} {\l__celtic_width_int-1}
{
  \tl_if_exist:cT {crossing ####1 - ##1}
  {
    \tl_if_eq:vnTF {crossing ####1 - ##1} {|}
    {
      \path[celtic~ bar/.try] (####1,##1-1) -- (####1,##1+1);
    }
    {
      \path[celtic~ bar/.try] (####1-1,##1) -- (####1+1,##1);
    }
  }
}
  }


  \int_step_inline:nnnn {1} {1} {\l__celtic_height_int-1}
  {
    \int_step_inline:nnnn {1 + \int_mod:nn {##1}{2}} {2} {\l__celtic_width_int-1}
{
    \celtic_generate_path:nnx {####1}{##1}{\int_eval:n {\l__celtic_flip_int*(2*\int_mod:nn{####1}{2} - 1)}}
    }
  }
  \celtic_render_path:
  \endpgfscope
  \group_end:
}

\cs_new_nopar:Npn \celtic_generate_path:nnn #1#2#3
{
  \bool_if:nF {
    \tl_if_exist_p:c {crossing #1 - #2}
    ||
    \tl_if_empty_p:c {crossing used #1 - #2}
  }
  {
    \tl_clear:c {crossing used #1 - #2}
    \int_set:Nn \l__celtic_x {#1}
    \int_set:Nn \l__celtic_y {#2}
    \int_set_eq:NN \l__celtic_ox \l__celtic_x
    \int_set_eq:NN \l__celtic_oy \l__celtic_y
    \int_set:Nn \l__celtic_dx {#3}
    \int_set:Nn \l__celtic_dy {1}

    \int_zero:N \l__celtic_int
    \bool_do_until:nn
    {
      (\int_compare_p:n {\l__celtic_x == \l__celtic_ox}
      &&
      \int_compare_p:n {\l__celtic_y == \l__celtic_oy}
      )
      || \int_compare_p:n {\l__celtic_int > \l__celtic_max_steps_int}
    }
    {
      \int_incr:N \l__celtic_int
      \celtic_next_crossing:
      \seq_put_left:NV \l__celtic_path_seq \l__celtic_path_tl
      \seq_put_left:NV \l__celtic_crossing_seq \l__celtic_crossing_tl
    }
    \int_compare:nT {\l__celtic_int > \l__celtic_max_steps_int}
    {
      % L3 this
      \message{Maximum~ of~ \int_use:N \l__celtic_max_steps_int ~ steps~ exceeded.}
    }
  }
}

\cs_generate_variant:Nn \celtic_generate_path:nnn {nnx}

\cs_new_nopar:Npn \celtic_render_path:
{

  \seq_map_inline:Nn \l__celtic_path_seq
  {
    \path[celtic~ path/.try] ##1;
  }
  \group_begin:
  \pgfscope
  \tikzset{celtic~ path/.try}
  \tl_use:c {tikz@double@setup}
  \tl_set:Nn \l__celtic_tmpa_tl
  {
    \endpgfscope
    \group_end:
    \fp_set:Nn \l__celtic_clip_fp
  }
  \tl_put_right:Nx \l__celtic_tmpa_tl {{\dim_use:N \pgflinewidth}}
  \tl_use:N \l__celtic_tmpa_tl

  \fp_set:Nn \l__celtic_inner_clip_fp {sqrt(2) * (\l__celtic_clip_fp + \l__celtic_inner_fp)}
  \fp_set:Nn \l__celtic_clip_fp {sqrt(2) * (\l__celtic_clip_fp + \l__celtic_outer_fp)}

  \seq_map_inline:Nn \l__celtic_path_seq
  {
    \seq_pop:NN \l__celtic_crossing_seq \l__celtic_crossing_tl
    \pgfscope
    \clip \l__celtic_crossing_tl +(-\fp_to_dim:N \l__celtic_inner_clip_fp,0) -- +(0,\fp_to_dim:N \l__celtic_inner_clip_fp) -- +(\fp_to_dim:N \l__celtic_inner_clip_fp,0) -- +(0,-\fp_to_dim:N \l__celtic_inner_clip_fp) --  +(-\fp_to_dim:N \l__celtic_inner_clip_fp,0);
    \path[celtic~ path/.try,double~ background] ##1;
    \endpgfscope
    \pgfscope
    \clip \l__celtic_crossing_tl +(-\fp_to_dim:N \l__celtic_clip_fp,0) -- +(0,\fp_to_dim:N \l__celtic_clip_fp) -- +(\fp_to_dim:N \l__celtic_clip_fp,0) -- +(0,-\fp_to_dim:N \l__celtic_clip_fp) --  +(-\fp_to_dim:N \l__celtic_clip_fp,0);
    \path[celtic~ path/.try,double~ foreground] ##1;
    \endpgfscope
  }
}


\ExplSyntaxOff


\makeatletter

\tikzset{
  double background/.code={%
    \begingroup
    \tikz@double@setup
    \global\pgf@xa=\pgflinewidth
    \endgroup
    \expandafter\tikz@semiaddlinewidth\expandafter{\the\pgf@xa}%
    \tikz@addmode{\tikz@mode@doublefalse}%
  },
  double foreground/.code={%
    \begingroup
    \tikz@double@setup
    \global\pgf@xa=\pgfinnerlinewidth
    \endgroup
    \expandafter\tikz@semiaddlinewidth\expandafter{\the\pgf@xa}%
    \tikz@addmode{\tikz@mode@doublefalse}%
    \tikzset{color=\pgfinnerstrokecolor}%
  },
}

\makeatother

\begin{document}
\begin{tikzpicture}[
  scale=.5,
  celtic path/.style={
    draw,
    double=gray!40,
    red,
    double distance=4mm,
    line width=1pt
  },
  celtic surround/.style={
    ultra thick,
    black,
    draw
  },
]
\CelticDrawPath[
  size={12,12},
  symmetric crossings={
    2:10,3:9,-
  },
  at={(1,1)}
]
\end{tikzpicture}

\begin{tikzpicture}[
  scale=.5,
  celtic path/.style={
    draw,
    double=white,
    red,
    double distance=5pt,
    line width=1pt
  },
  celtic bar/.style={
    ultra thick,
    black,
    draw
  },
]
\draw[gray!30,ultra thin] (0,0) grid (20,12);
\CelticDrawPath[
  size={20,12},
  symmetric crossings={
    10,1,|;
    3,2,|;
    3,4,|;
    6,3,|;
    10,5,|;
    10,3,-;
    9,6,-;
    6,5,-;
    3,6,-;
    1,4,-
  },
]
\end{tikzpicture}

\newpage

\begin{tikzpicture}[
  scale=.5,
  celtic path/.style={
    draw,
    double=white,
    red,
    double distance=5pt,
    line width=1pt
  },
  celtic bar/.style={
    ultra thick,
    black,
    draw
  },
]
\CelticDrawPath[
  size={20,40},
  symmetric crossings={
    3,4:36,|;
    4:16,3,-
  },
  max steps=1000
]
\end{tikzpicture}



\end{document}
